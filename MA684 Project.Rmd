---
title: "MA684 Midterm Project"
author: "Dongyuan Zhou"
date: "November 13, 2017"
output:
  pdf_document: default
  html_document: default
---
 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggmap)
library(maps)
library(reshape2)
library(gridExtra)
library(VGAM)
library(hett)
library(MASS)
library(lme4)
library(devtools)
library(wordcloud2)
library(openintro)
library(knitr)
pacman::p_load("arm","rstanarm","data.table","car","merTools")
```

## Background
In the financial field, making decisions on whether to lend money to borrowers is one of the most important work. A whole cycle of this work usually includes the following two steps. 

Firstly, grades the loan according to the borrower credit record as well as the loan amount and loan time, and then make decision whether lend or not.

Secondly, summarize the default rate and improve the former step to avoid default next time.

## Objective

In this analysis, we analyze data from Lending club (LC):

\textbf{Stage1: Initial EDA (Data: 2015-2017)}

Analyze how borrower's status inluenced their loan amount? (Linear regression)

\textbf{Stage2: Before loan was funded (Data: 2015-2017)}

Analyze how LC assigned loan grade: How borrower's status as well as the loan amount and loan time influenced loan grade? (Multinomial regreesion)

\textbf{Stage3: After laon ended (Data: 2007-2011)}

Summarize default rate for each state.(Multilevel logistic regression)

\textbf{Stage4: Summarize and Discussion}

Assessment of	the	result. Discuss about the data limitations and future	directions.

## Data description

Data source: [https://www.lendingclub.com/info/download-data.action](https://www.lendingclub.com/info/download-data.action)

To get reasonable analysis, we only choose the data which had been verified by LC.

In the whole analysis, we transform loan grade to grade number.

\begin{table}[ht]
\centering
\begin{tabular}{lrrrrrrr}
  \hline
grade & A & B & C & D & E & F & G\\ 
  \hline
gradenumber & 7 & 6 & 5 & 4 & 3 & 2 & 1 \\ 
   \hline
\end{tabular}
\end{table}

```{r, echo=FALSE}
## Final Data
Loan1517 <- read.table("Loan1517.csv", header = TRUE, sep = ",")
Loan0711 <- read.table("Loan0711.csv", header = TRUE, sep = ",")
Loan1517$year <- ifelse(Loan1517$term == "36",3,5)
Loan0711$year <- ifelse(Loan0711$term == "36",3,5)
Loan0711$default <- ifelse(Loan0711$loan_status == "Fully Paid",0,1)
Loan1517$region <- tolower(Loan1517$region)
Loan0711$region <- tolower(Loan0711$region)
Loan0711$dti <- Loan0711$dti/100
Loan1517$dti <- Loan1517$dti/100
```

## Analysis Part

### 1. Initial EDA

Analyze how borrower's status inluenced their loan amount? (Linear regression)

#### Initial EDA

1. How home ownership influenced loan amount?

2. How employment years inluenced loan amount?

3. How loan purpose influenced loan amount?

4. How state status influenced loan amount?

5. How monthly income influenced loan amount?

```{r, echo=FALSE, warning=FALSE}
# 1. How home ownership influenced loan amount?
home <- summarise(group_by(Loan1517,Loan1517$home_ownership),
                  loan_amnt = mean(loan_amnt, na.rm = TRUE))
home$home_ownership <- home$`Loan1517$home_ownership`
p1 <- ggplot(home)+
  aes(x=reorder(home$home_ownership,loan_amnt),y = log(loan_amnt),
      fill=reorder(home$home_ownership,loan_amnt))+
  geom_bar(stat = "identity",width = 0.5)+
  geom_text(aes(label = round(loan_amnt)),size = 3,vjust = -1)+
  xlab("Home ownership")+
  ylab("Loan amount")+
  labs(title = "Home ownership")+
  theme(plot.title = element_text(hjust = 0.5),legend.position="none")

# 2. How employment years inluenced loan amount?
emp_year <- summarise(group_by(Loan1517,Loan1517$emp_year),
                      loan_amnt = mean(loan_amnt, na.rm = TRUE))
emp_year$emp_years <- emp_year$`Loan1517$emp_year`
p2 <- ggplot(emp_year)+
  aes(factor(emp_years), y =  log(loan_amnt),fill = factor(emp_years))+
  geom_bar(stat = "identity",width = 0.5)+
  xlab("Employment year")+
  ylab("Loan amount")+
  labs(title = "Employment year")+
  theme(plot.title = element_text(hjust = 0.5),legend.position="none")
grid.arrange(p1,p2,ncol =2)

```

From the chart above, we could see that borrowers whose home is mortgage had greater loam amount than the other three types. 

For the employment length, it seems that borrowers who was just get their jobs had more loan amount than those who had already work for years.

```{r, echo=FALSE, warning=FALSE}
# 3. How loan purpose influenced loan amount?
loanpurpose <- summarise(group_by(Loan1517,Loan1517$purpose),
                         loan_amnt = mean(loan_amnt, na.rm = TRUE))
loanpurpose$loan_purpose <- loanpurpose$`Loan1517$purpose`
p3 <- ggplot(loanpurpose)+
  aes(reorder(loanpurpose$loan_purpose,loan_amnt),y = log(loan_amnt),
      fill=reorder(loanpurpose$loan_purpose,loan_amnt))+
  geom_bar(stat = "identity",width = 0.5)+
  xlab("Purpose")+
  ylab("Loan amount")+
  labs(title = "Purpose")+
  theme(plot.title = element_text(hjust = 0.5),legend.position="none")+
  coord_flip()
p3
```

Borrowers who loaned money for business, they had greater loan amount than those who loaned just for vacation. 

```{r, echo=FALSE, warning=FALSE}
# 4. How state status influenced loan amount?
us <- map_data("state")
arr <- USArrests %>% 
  add_rownames("region") %>% 
  mutate(region=tolower(region))
stateofloan <- Loan1517%>%
  group_by(region)%>%
  summarise(amount = sum(loan_amnt), abbr = unique(addr_state))
stateofloan <- merge(arr, stateofloan,by = "region")
p4 <- ggplot()+
  geom_map(data=us, map=us, aes(x=long, y=lat, map_id=region),
           fill="#ffffff", color="#ffffff", size=0.15)+
  geom_map(data=stateofloan, map=us, aes(fill=log(amount), map_id=region), 
           color="#ffffff", size=0.15)+
  scale_fill_continuous(low='thistle2', high='darkred',guide='colorbar')+
  ylab("Loan amount")+
  labs(x=NULL, y=NULL,title = "state")+
  theme(plot.title = element_text(hjust = 0.5),legend.position="none")+
  coord_map("albers", lat0 = 39, lat1 = 45) 
# no data for Iowa
p4
```

From the map we could clear see that loan amount in CA, TX, FL and NY is higher than other states, which reflects the financial demand in each state.

```{r, echo=FALSE, warning=FALSE}
# 5. How monthly income influenced loan amount?
income <- summarise(group_by(Loan1517,Loan1517$monthly_inc),
                    loan_amnt = mean(loan_amnt, na.rm = TRUE))
income$monthly_inc <- income$`Loan1517$monthly_inc`
p5 <- ggplot(income)+
  aes(x = log(monthly_inc), y =  log(loan_amnt))+
  geom_point(alpha=0.1)+
  coord_flip()+
  labs(title = "Monthly income")+
  xlab("Monthly income")+
  ylab("Loan amount")+
  theme(plot.title = element_text(hjust = 0.5))
p5
```

For the monthly income, borrowers who receive higher income per month could have higher loan amount, it is reasonable since they seemd to have higher debt-paying ability, and they seemed to have more source of demand for money.

#### Model

Then we fit a linear model to show the relationship between loan amount and borrower's status.

\textbf{model 1} lm(log(loan_amnt) ~ log(monthly_inc) + purpose + home_ownership + emp_year + addr_state)

```{r, echo=FALSE}
# fit model
model1_1 <- lm(log(loan_amnt) ~ log(monthly_inc) + purpose + home_ownership + 
                 emp_year + addr_state, data = Loan1517)
plot(fitted(model1_1),model1_1$residuals)
abline(0,0, col="red")
```

Check the residual: 

Residual standard error: 0.6091.

The residual plot shown above has a trend, which means that this model has problems and maybe other factors should be included into consideration.

Interpret:

For each 1% difference in monthly income, the predicted difference in loan amount is 0.63%. 

For each 1% difference in employment year, the predicted difference in loan amount is 0.003%. 

The other input, purpose, home ownership, state, is categorical so it does not make sense to take its logarithm.

### 2. Before loan was funded (Data:2015-2017)

Analyze how LC assigned loan grade: How borrower's status as well as the loan amount and loan time influenced loan grade? (Multinomial regreesion)

#### Initial EDA: [https://dongyuanzhou.shinyapps.io/ma684_shiny/](https://dongyuanzhou.shinyapps.io/ma684_shiny/)

From the link, we could see that higher loan amount, lower loan grade; lower income, lower loan grade; What's more, longer loan term means higher probability to have lower loan grade and borrowers who rent their home seems to has lower loan grade. There is not much significant diffenrence according the the EDA for loan purose and loan state. Maybe we could use the multilevel regression to show the result.

#### Model

Then we fit a linear model to show the relationship between loan amount and borrower's status as well as the loan amount and loan time.

\textbf{model 2} polr(grade ~ log(loan_amnt) + year + log(monthly_inc) + home_ownership + emp_year + purpose + addr_state)

```{r, echo=FALSE}
## fit models
## model2_0
model2_0<- polr(grade ~ log(loan_amnt) + year + log(monthly_inc) + 
                  home_ownership + emp_year + purpose + addr_state, 
                data = Loan1517)
```

Check residuals: Residual Deviance: 567279.20 

AIC: 567425.20 

Interpret:

We get emp_year that is positive and insignificant contrary to our expectation. It seems reasonable to remove emp_year variable from our model. Meanwhile, according to the industry regulation, loan purpose and state of loan has little significance compared to monthly income and loan amount.

Therefore, we consider a new model for the grade of loan as a function of loan amount, loan term and borrower's monthly income.

\textbf{model 3} polr(grade ~ log(loan_amnt) + year + log(monthly_inc))

```{r, echo=FALSE}
## model2_1 
model2_1<- polr(grade ~ log(loan_amnt) + year + log(monthly_inc), 
                data = Loan1517)
summary(model2_1)
```

Check rediduals: Residual Deviance: 575377.17 

AIC: 575395.17 

Then we predict the loan grade for loan term between 3 years to 5 years, monthly income equals 1000 to 40000 and loan amount equals 1000 to 300000.

```{r, echo=FALSE}
predx<-expand.grid(loan_amnt=seq(1000,40000,length.out=5),
                   year=3:5,monthly_inc=seq(1000,300000,length.out=5))
predy<-predict(model2_1,newdata=predx,type="prob")

ggplot(melt(data.frame(predx,predy),
            id.vars = c("loan_amnt", "year", "monthly_inc")))+
  geom_point(alpha=0.3)+
  aes(x=log(monthly_inc),y=value,group=variable)+
  facet_grid(loan_amnt~year,scale="free_x")+
  labs(title = "Prediction: term(3y~5y), income (1k~30k), amount (1k~40k)")+
  theme(plot.title = element_text(hjust = 0.5))
```

### 3. After laon ended (Data: 2007-2011)

Summarize default rate for each state.(Multilevel logistic regression)

dti: Debt to income ratio

#### Initial EDA

```{r, echo=FALSE, warning=FALSE}
default <- Loan0711%>%
  group_by(region)%>%
  summarise(defrate = sum(default)/length(default))
default <- merge(arr, default,by = "region")
ggplot()+
  geom_map(data=us, map=us, aes(x=long, y=lat, map_id=region),
           fill="#ffffff", color="#ffffff", size=0.15)+
  geom_map(data=default, map=us, aes(fill=defrate, map_id=region), 
           color="#ffffff", size=0.15)+
  scale_fill_continuous(low='thistle2', high='darkred',guide='colorbar')+
  labs(x=NULL, y=NULL,title = "Default rate in different state")+
  theme(plot.title = element_text(hjust = 0.5),legend.position="none")+
  coord_map("albers", lat0 = 39, lat1 = 45)

Loan0711$dtiindex <- ifelse(Loan0711$dti < 0.10,"0-0.1",
                            ifelse(Loan0711$dti <0.20,"0.10-0.20","0.2+"))
ggplot(Loan0711)+aes(x=grade,fill=factor(default))+
geom_bar(position="fill")+facet_grid(~dtiindex)+
labs(title = "Default rate according to dti and loan grade")+
scale_fill_manual(values=c("seagreen4","red3"))+ylab("Default rate")+xlab("Grade")+
  theme(plot.title = element_text(hjust = 0.5),legend.position="none")
```

#### Model

First, we fit a logistic model to show the relationship between the default rate and loan grade as well as the Debt to income ratio.

\textbf{model 4} glm(default ~ gradenum + dti, family=binomial)

```{r, echo=FALSE, warning=FALSE}
model3_0 <- glm(default ~ gradenum + dti, family=binomial, data = Loan0711)
mmps(model3_0)
binnedplot(fitted(model3_0),residuals(model3_0,type="response"))
errorrate_model3_0 <- mean((predict(model3_0) > 0.5 & Loan0711$default == 0) |
                             (predict(model3_0) < 0.5 & Loan0711$default == 1))
```

Check model:

From the binned plot, we could see a disturbing pattern, with an extreme negative residual in the last bins: people in the lowest bin are about 10% less likely to default than is predicted by the model.

The error rate for the model is 16%.

interpret:

1 sd increase in debt-to-income ratio has a multiple effect of exp(0.01)=1.01 on odds od default,controling grade in same level.

The odds ratio of default for grade A vs grade G is exp(1.8)= 6.05

The loan in grade B is 0.75/4=19% more likely to default than loan in grade A.

The loan in grade C is 1.13/4=28% more likely to default than loan in grade A.

The loan in grade D is 1.38/4=35% more likely to default than loan in grade A.

The loan in grade E is 1.70/4=43% more likely to default than loan in grade A.

The loan in grade F is 1.94/4=49% more likely to default than loan in grade A.

The loan in grade G is 1.82/4=46% more likely to default than loan in grade A.

Since state and purpose may also has influence on the default rate, we fit multilevel model to see if there is some difference between state as well as purpose.

\textbf{model 5} glmer(default ~ gradenum + dti + (1|addr_state), family=binomial(link="logit"))

\textbf{model 6} glmer(default ~ gradenum + dti + (1 + gradenum|addr_state), family=binomial(link="logit"))

```{r, echo=FALSE}
## Multilevel model
# state
model3_2 <- glmer(default ~ gradenum + dti + (1|addr_state), 
                  family=binomial(link="logit"), data = Loan0711)
model3_1 <- glmer(default ~ gradenum + dti + (1 + gradenum|addr_state), 
                  family=binomial(link="logit"), data = Loan0711)

a.hat.model3_2 <- fixef(model3_2)[1] + ranef(model3_2)$addr_state 
b.hat.model3_2 <- fixef(model3_2)[2]
c.hat.model3_2 <- fixef(model3_2)[3]

a.hat.model3_1 <- fixef(model3_1)[1] + ranef(model3_1)$addr_state[1]
b.hat.model3_1 <- fixef(model3_1)[2] + ranef(model3_1)$addr_state[2]
c.hat.model3_1 <- fixef(model3_1)[3]
x <- Loan0711$gradenum
y <- Loan0711$default
dti <- Loan0711$dti
state <- unique(Loan0711$addr_state)
J <- length(state)
newstate <- rep (NA, J)
for (i in 1:J){newstate[Loan0711$addr_state==state[i]] <- i}
par(mfrow=c(3,5), mar=c(4,4,3,1), oma=c(1,1,2,1))
for (j in 1:J){
plot (x[newstate==j], y[newstate==j],xlim=c(0,7),ylim=c(0,1),
xlab="gradenum", ylab="default rate",main = state[j])
curve (invlogit(a.hat.model3_1[j,] + b.hat.model3_1[j,]*x + c.hat.model3_1*dti[j]), 
       col="red", add=TRUE)
curve (invlogit(a.hat.model3_2[j,] + b.hat.model3_2*x + c.hat.model3_2*dti[j]), 
       col="blue", add=TRUE)
}
```

\textbf{model 7} glmer(default ~ gradenum + dti + (1|purpose), family=binomial(link="logit"))

\textbf{model 8} glmer(default ~ gradenum + dti + (1 + gradenum|purpose), family=binomial(link="logit"))

```{r, echo=FALSE, warning=FALSE}
# purpose
model4_2 <- glmer(default ~ gradenum + dti + (1|purpose), 
                  family=binomial(link="logit"), data = Loan0711)
model4_1 <- glmer(default ~ gradenum + dti + (1 + gradenum|purpose), 
                  family=binomial(link="logit"), data = Loan0711)
a.hat.model4_2 <- fixef(model4_2)[1] + ranef(model4_2)$purpose 
b.hat.model4_2 <- fixef(model4_2)[2]
c.hat.model4_2 <- fixef(model4_2)[3]

a.hat.model4_1 <- fixef(model4_1)[1] + ranef(model4_1)$purpose[1]
b.hat.model4_1 <- fixef(model4_1)[2] + ranef(model4_1)$purpose[2]
c.hat.model4_1 <- fixef(model4_1)[3]
x <- Loan0711$gradenum
y <- Loan0711$default
dti <- Loan0711$dti
purpose <- unique(Loan0711$purpose)
J <- length(purpose)
newpurpose <- rep (NA, J)
for (i in 1:J){newpurpose[Loan0711$purpose==purpose[i]] <- i}
par(mfrow=c(3,5), mar=c(4,4,3,1), oma=c(1,1,2,1))
for (j in 1:J){
plot (x[newpurpose==j], y[newpurpose==j],xlim=c(0,7),ylim=c(0,1),
xlab="gradenum", ylab="default rate",main = purpose[j])
curve (invlogit(a.hat.model4_1[j,] + b.hat.model4_1[j,]*x + c.hat.model4_1*dti[j]),
       col="red", add=TRUE)
curve (invlogit(a.hat.model4_2[j,] + b.hat.model4_2*x + c.hat.model4_2*dti[j]),
       col="blue", add=TRUE)
}
```

From the plot above, we could see that there is some difference if we include state as random effect, especially in CA.

Also, there is difference for the house purpose when we include it as random effect.

Then we fit a mixed effect model and show the result in CA, we could see that the difference is not very precise. 

```{r, echo=FALSE, warning=FALSE}
model5_1 <- glmer(default ~ gradenum + dti +(1|addr_state) + (1 + gradenum|purpose), 
                  family=binomial(link="logit"), data = Loan0711)

example <- draw(model5_1, type = 'average', varList = list("addr_state" = "CA"))

tempdf <- wiggle(example, var = "gradenum", c(1:7))
tempdf <- wiggle(tempdf, var = "purpose", 
                    unique(Loan0711$purpose))
tempdf$yhat <- predict(model5_1, newdata = tempdf, type = "response",allow.new.levels = TRUE)

exampPreds <- predictInterval(model5_1, newdata = tempdf, 
                              type = "probability", 
                              include.resid.var = FALSE, level = 0.8)
tempdf <- cbind(tempdf[, c(1:6)], exampPreds)

ggplot(tempdf, aes(x = purpose, y = fit, ymin = lwr, ymax = upr, 
                   group = gradenum)) + 
  geom_ribbon(aes(fill = factor(gradenum)), alpha = I(0.2), color = I("black"))+ 
  geom_line(aes(color = factor(gradenum))) + 
  theme_bw() + ylim(c(0, 1)) + labs(title = "Default Rate in CA")+
  theme(axis.text.x = element_text(angle = 20), 
        legend.position = "bottom") + labs(x = "Purpose", y = "Probability")
```

### 4. Discussion

\textbf{1. Result}

From this analysis report, we could know that the loan grade is significantly related to loan amount and loan term. What's more, if borrower had another mortgage, the grade would be higher as expected. This is reasonable, since their credit quality had checked by other institutions. However, the employment year is not such related as common sense, and this is a point that could be analyze deeper.

For default rate, the higher grade reflect the lower default rate. What's more, the initial debt to income ratio is also important. From the analysis, we could give suggestion that grade F and grade G has really high default rate, and reject their loan request may be a better desicion.

\textbf{2. Data limitation}

Since the credit information is private, we cannot track the whole process for each loan. 

What's more, the FICO Score should be an important predictor in this analysis,however, since it is personal privacy, we could not get the data. Therefore, just consider about the factor as home ownership and income has its limitation.

Finally, since the financial market and the interest rate policy has changed during years, credit quality could not be the only factor of default. Other investment chances and bank loan should be considered and the time span is important.

\textbf{3. Future directions}

Combine the bank interest rate in each years analysis is what we could consider deeper, and basic financial knowledge is required.
Moreover, since the loan is always span 3-5 years or more, maybe we could track the result years later.

# Appendix and reference

Data source: [https://www.lendingclub.com/info/download-data.action](https://www.lendingclub.com/info/download-data.action)

Code for data cleaning: ["data clean.R"](https://github.com/DongyuanZhou/MA684-Project/blob/master/data%20clean.R)

Code for model: ["MA684 Project.Rmd"](https://github.com/DongyuanZhou/MA684-Project/blob/master/MA684%20Project.Rmd)

Initial EDA: [https://dongyuanzhou.shinyapps.io/ma684_shiny/](https://dongyuanzhou.shinyapps.io/ma684_shiny/)
